<?xml version="1.0" encoding="UTF-8"?>
<ClinicalDocument xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="urn:hl7-org:v3 Schemas/CDA-PITO-E2E.xsd"
 xmlns="urn:hl7-org:v3"
 xmlns:hl7="urn:hl7-org:v3"
 xmlns:xs="http://www.w3.org/2001/XMLSchema"
 xmlns:e2e="http://standards.pito.bc.ca/E2E-DTC/cda">
<!-- 
********************************************************
CDA Header
********************************************************
-->
	<realmCode code="CA" />
	<typeId root="2.16.840.1.113883.1.3" extension="POCD_HD000040"/>
	<id extension="$patient.demographicNo" root="2.16.840.1.113883.3.933"/>
	<code code="34140-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Referral"/>
	<title>PITO EMR-2-EMR Complete Instance Example</title>
	<effectiveTime value="$date.get('yyyyMMddhhmm')"/>
	<confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25"/>
	<!-- 
	********************************************************
	Record Target
	********************************************************
	-->
	<recordTarget typeCode="RCT" contextControlCode="OP">
		<patientRole classCode="PAT">
			<id extension="$patient.hin" root="2BFBA1E9-79C2-4bbb-B589-41B949BD6A3B" assigningAuthorityName="BC-PHN"/>
			<patient>
				<administrativeGenderCode code="$patient.gender" codeSystem="2.16.840.1.113883.5.1" codeSystemName="HL7 - Administrative Gender" displayName="$patient.genderDesc"/>
				<birthTime value="$patient.birthDate"/>
			</patient>
		</patientRole>
	</recordTarget>
	<!-- 
	********************************************************
	Author
	********************************************************
	-->
	<author typeCode="AUT" contextControlCode="OP">
		<time value="$currentDate"/>
		<assignedAuthor>
			<id extension="$authorId" root="$authorIdRoot"/>
		</assignedAuthor>
	</author>
	
	<!-- 
	********************************************************
	Custodian
	******************************************************** -->
	<custodian typeCode="CST">
		<assignedCustodian classCode="ASSIGNED">
			<representedCustodianOrganization classCode="ORG" determinerCode="INSTANCE">
				<id extension="$custodianId" root="$custodianIdRoot"/>
			</representedCustodianOrganization>
		</assignedCustodian>
	</custodian>
	<!-- 
********************************************************
e-MS CDA Structured Body
********************************************************
-->
	<component>
		<structuredBody>
<!--
********************************************************
Medications & Prescriptions - Medication List
********************************************************
-->
#if ( $patient.hasMedications() )
			<component typeCode="COMP" contextConductionInd="true">
				<section classCode="DOCSECT" moodCode="EVN">
					<templateId root="2.16.840.1.113883.3.1818.10.2.19.1"/>
					<code code="10160-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Medication Use"/>
					<title>Medications and Prescriptions - Medication List [with entries]</title>
	#foreach( $med in $patient.getMedications() )
					<entry typeCode="COMP" contextConductionInd="true">
						<templateId root="2.16.840.1.113883.3.1818.10.3.18" />
						<substanceAdministration classCode="SBADM" moodCode="EVN">
							<id extension="$med.drugId" root="OSCAR.local" />
							<code code="DRUG" codeSystem="2.16.840.1.113883.5.4" displayName="Drug Therapy"/>
		#if ( $med.isActive() )
							<statusCode code="active"/>
		#else
							<statusCode code="completed"/>
		#end
							<effectiveTime xsi:type="IVL_TS" operator="I">
								<low value="$date.format('yyyyMMdd', $med.getStartDate())"/>
								<high value="$date.format('yyyyMMdd', $med.getEndDate())" />
							</effectiveTime>
							<!--Medication Identification-->
							<consumable typeCode="CSM">
								<templateId root="2.16.840.1.113883.3.1818.10.4.16"/>
								<manufacturedProduct classCode="MANU">
									<manufacturedMaterial classCode="MMAT" determinerCode="KIND">
										<code code="$med.din" codeSystem="2.16.840.1.113883.5.1105" displayName="HC-DIN"/>
										<name>$med.drugName</name>
									</manufacturedMaterial>
								</manufacturedProduct>
							</consumable>    
							<!--end Medication Identification-->
						</substanceAdministration>
					</entry>
				</section>
			</component>
	#end
#else
			<component typeCode="COMP" contextConductionInd="true">
				<section classCode="DOCSECT" moodCode="EVN">
					<templateId root="2.16.840.1.113883.3.1818.10.2.19.1"/>
					<code code="10160-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Medication Use"/>
					<title>Medications and Prescriptions - Medication List [without entries]</title>
					<text>Sorry, no medications</text>
				</section>
			</component>
#end
		</structuredBody>
	</component>
</ClinicalDocument>
